"use strict";var u=Object.defineProperty;var v=Object.getOwnPropertyDescriptor;var D=Object.getOwnPropertyNames;var w=Object.prototype.hasOwnProperty;var p=(s,e)=>u(s,"name",{value:e,configurable:!0});var A=(s,e)=>{for(var i in e)u(s,i,{get:e[i],enumerable:!0})},R=(s,e,i,d)=>{if(e&&typeof e=="object"||typeof e=="function")for(let t of D(e))!w.call(s,t)&&t!==i&&u(s,t,{get:()=>e[t],enumerable:!(d=v(e,t))||d.enumerable});return s};var k=s=>R(u({},"__esModule",{value:!0}),s);var S={};A(S,{Scope:()=>g,Strategy:()=>c});module.exports=k(S);var m=require("builder-validation"),a=require("passport-oauth2");var c=class extends a.Strategy{static{p(this,"Strategy")}name="discord";scope;scopeDelay;fetchScopeEnabled;constructor(e,i){new m.Schema().addString({name:"clientId",description:"The client ID assigned by Discord.",required:!0}).addString({name:"clientSecret",description:"The client secret assigned by Discord.",required:!0}).addString({name:"callbackUrl",description:"The URL to which Discord will redirect the user after granting authorization.",required:!0}).addArray({name:"scope",description:"An array of permission scopes to request.",required:!0}).addNumber({name:"scopeDelay",description:"The delay in milliseconds between requests for the same scope.",required:!1}).addBoolean({name:"fetchScope",description:"Whether to fetch data for the specified scope.",required:!1}).addString({name:"authorizationUrl",description:"The base URL for OAuth2 authorization.",required:!1}).addString({name:"tokenUrl",description:"The base URL for OAuth2 token issuance.",required:!1}).addString({name:"scopeSeparator",description:"The separator for the scope values.",required:!1}).validate(e).then(t=>{if(typeof t=="string")throw new Error(t)}),super({clientID:e.clientId,callbackURL:e.callbackUrl,authorizationURL:e.authorizationUrl??"https://discord.com/api/oauth2/authorize",tokenURL:e.tokenUrl??"https://discord.com/api/oauth2/token",scopeSeparator:" ",...e},i),this.scope=e.scope??[],this.scopeDelay=e.scopeDelay??0,this.fetchScopeEnabled=e.fetchScope??!0,this._oauth2.useAuthorizationHeaderforGET(!0)}userProfile(e,i){this._oauth2.get("https://discord.com/api/users/@me",e,(d,t)=>{if(d)return i(new a.InternalOAuthError("Failed to fetch the user profile.",d));let o={};try{if(typeof t!="string")return i(new Error("Failed to parse the user profile."));let r=JSON.parse(t),h=14200704e5,_=1<<22;if(o={provider:"discord",id:r.id,username:r.username,displayName:r.displayName,discriminator:r.discriminator,avatar:r.avatar,banner:r.banner,email:r.email,verified:r.verified,mfa_enabled:r.mfa_enabled,access_token:e,public_flags:r.public_flags,flags:r.flags,locale:r.locale,global_name:r.global_name,premium_type:r.premium_type,connections:r.connections,guilds:r.guilds,fetchedAt:new Date,createdAt:new Date(+r.id/_+h),_raw:t,_json:r},this.fetchScopeEnabled===!1)return i(null,o);this.fetchScope("connections",e,(l,b)=>{if(l)return i(l);o.connections=b,this.fetchScope("guilds",e,(f,y)=>{if(f)return i(f);o.guilds=y,o.fetchedAt=new Date,i(null,o)})})}catch{return i(new Error("Failed to parse the user profile."))}})}fetchScope(e,i,d){if(!this.scope.includes(e))return d(null,null);setTimeout(()=>{this._oauth2.get(`https://discord.com/api/users/@me/${e}`,i,(t,o)=>{if(t)return d(new a.InternalOAuthError(`Failed to fetch the scope: ${e}`,t));try{if(typeof o!="string")return d(new Error(`Failed to parse the returned scope data: ${e}`));let r=JSON.parse(o);d(null,r)}catch{d(new Error(`Failed to parse the returned scope data: ${e}`))}})},this.scopeDelay??0)}authorizationParams(e){let i=super.authorizationParams(e);return"permissions"in e&&(i.permissions=e.permissions),"prompt"in e&&(i.prompt=e.prompt),"disable_guild_select"in e&&(i.disable_guild_select=e.disable_guild_select),"guild_id"in e&&(i.guild_id=e.guild_id),i}};var g=(n=>(n.ActivitiesRead="activities.read",n.ActivitiesWrite="activities.write",n.ApplicationBuildsRead="applications.builds.read",n.ApplicationBuildsUpload="applications.builds.upload",n.ApplicationsCommands="applications.commands",n.ApplicationsCommandsUpdate="applications.commands.update",n.ApplicationsCommandsPermissionsUpdate="applications.commands.permissions.update",n.ApplicationsEntitlements="applications.entitlements",n.ApplicationsStoreUpdate="applications.store.update",n.Bot="bot",n.Connections="connections",n.DMRead="dm_channels.read",n.Email="email",n.GdmJoin="gdm.join",n.Guilds="guilds",n.GuildsJoin="guilds.join",n.GuildMembersRead="guilds.members.read",n.Identify="identify",n.MessagesRead="messages.read",n.RelationshipsRead="relationships.read",n.RoleConnectionsWrite="role_connections.write",n.RPC="rpc",n.RPCActivitiesUpdate="rpc.activities.update",n.RPCNotificationsRead="rpc.notifications.read",n.RPCVoiceRead="rpc.voice.read",n.RPCVoiceWrite="rpc.voice.write",n.Voice="voice",n.WebhookIncoming="webhook.incoming",n))(g||{});0&&(module.exports={Scope,Strategy});
//# sourceMappingURL=index.js.map