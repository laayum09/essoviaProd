// -------------------------------------------
//  Prisma Schema for Essovia Store API
//  Database: MongoDB
// -------------------------------------------

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}


datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// -------------------------------------------
//  USER MODEL
// -------------------------------------------
model User {
  id          String        @id @default(auto()) @map("_id") @db.ObjectId
  databaseId  String        @unique
  discordId   String        @unique
  robloxId    String        @unique
  credits     Int           @default(0)
  products    UserProduct[] @relation("userProducts")
  whitelists  Whitelist[]   @relation("userWhitelists")
  purchases   Purchase[]    @relation("userPurchases")
}

// -------------------------------------------
//  PRODUCT MODEL
// -------------------------------------------
model Product {
  id           String         @id @default(auto()) @map("_id") @db.ObjectId
  productId    String         @unique
  name         String
  priceR       Int?
  priceC       Int?
  whitelisted  Boolean        @default(false)
  fileUrl      String?
  version      String?        @default("1.0.0")  // ✅ new field
  users        UserProduct[]  @relation("userProducts")
  whitelists   Whitelist[]    @relation("productWhitelists")
  purchases    Purchase[]     @relation("productPurchases")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([name])
}

// -------------------------------------------
//  USER ↔ PRODUCT LINK (ownership)
// -------------------------------------------
model UserProduct {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  userDatabaseId  String
  productId       String
  whitelistSetup  Boolean @default(false)

  user    User    @relation("userProducts", fields: [userDatabaseId], references: [databaseId])
  product Product @relation("userProducts", fields: [productId], references: [productId])

  @@unique([userDatabaseId, productId], name: "user_databaseId_productId")
}

// -------------------------------------------
//  WHITELIST MODEL
// -------------------------------------------
model Whitelist {
  id              String  @id @default(auto()) @map("_id") @db.ObjectId
  whitelistId     String  @unique
  userDatabaseId  String
  productId       String
  type            String   // "user" or "group"
  userid          String

  user    User    @relation("userWhitelists", fields: [userDatabaseId], references: [databaseId])
  product Product @relation("productWhitelists", fields: [productId], references: [productId])
}

// -------------------------------------------
//  PURCHASE HISTORY MODEL
// -------------------------------------------
model Purchase {
  id           String  @id @default(auto()) @map("_id") @db.ObjectId
  purchaseId   String  @unique
  databaseId   String
  productId    String
  method       String   // R (Robux), C (Credits), U (Unlocked/Admin)
  amount       Int?
  timestamp    DateTime @default(now())

  user    User    @relation("userPurchases", fields: [databaseId], references: [databaseId])
  product Product @relation("productPurchases", fields: [productId], references: [productId])
}
